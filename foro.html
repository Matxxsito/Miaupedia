<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Foro | MIAUPEDIA</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="content">
  <h1>ğŸ¾ Foro Gatuno</h1>

  <textarea id="mensaje" placeholder="Comparte algo sobre tu gato"></textarea>
  <input type="file" id="imagen">
  <button onclick="publicar()">Publicar</button>

  <div id="posts"></div>
</div>
<script type="module" src="firebase/firebase-config.js"></script>

<script src="js/firebase.js"></script>
<script>
auth.onAuthStateChanged(user => {
  if (!user) window.location.href = "login.html";
});

function publicar() {
  const file = imagen.files[0];
  const ref = storage.ref("posts/" + Date.now());
  
  ref.put(file).then(snapshot => {
    snapshot.ref.getDownloadURL().then(url => {
      auth.currentUser && db.collection("posts").add({
        uid: auth.currentUser.uid,
        mensaje: mensaje.value,
        imagen: url,
        fecha: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
  });
}

db.collection("posts").orderBy("fecha", "desc")
.onSnapshot(snapshot => {
  posts.innerHTML = "";
  snapshot.forEach(doc => {
    posts.innerHTML += `
      <div class="card">
        <img src="${doc.data().imagen}" width="100%">
        <p>${doc.data().mensaje}</p>
      </div>
    `;
  });
});
</script>

</body>
</html>
